{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load crispy_forms_tags %}

{% block header %}

<!-- Header -->
<header class="trips-head">
	<div class="container d-flex align-items-center">
		<div class="mx-auto text-center">
			<h1 class="text-light mx-auto my-0">Checkout 2</h1>
		</div>
	</div>
</header>

{% endblock %}

{% block content %}

<!-- Register passenger section -->
<section class="bg-light">
	<div class="container pt-5 pb-5">
		<div class="row">

			{% for item in cart_items %}
			<div class="col-12 col-md-10 mx-auto jumbotron">

				<div class="col-12 mb-2 text-left">
					<!-- Trip recap -->
					{% include 'components/trip_recap.html' %}
				</div>

				<!-- Passengers -->
				{% for i in item.passenger_range %}
				<div class="col-12 mb-3">
					<div class="card collapse-container">

						<div class="card-header header text-uppercase text-left">
							<b><i class="fas fa-user"></i> Passenger {{ forloop.counter }}</b> Adult
                            <span class="checkmark">&#9989;</span>
						</div>

						<div class="card-body content mb-3">
							<div class="row">

								{% if forloop.counter == 1 %}
								<div class="col-12">
									<p>Who is traveling?</p>
								</div>
								<div class="col-12">
									<select id="traveling-passenger" name="traveling-passenger" class="passenger-traveling-select">
                                                    <option value="1" selected>{{ user.first_name }} {{ user.last_name }}</option>
                                                    <option value="2">I am booking for another passenger</option>
                                        </select>
								</div>

								<div class="mt-5 col-12 user-passenger-form">
									<!-- User passenger details form -->
									{% include 'components/user_passenger_form.html' %}
								</div>

								<div class="mt-5 col-12 other-passenger-form">
									<!-- Other passenger details form -->
									{% include 'components/other_passenger_form.html' %}
								</div>

								{% else %}
								<div class="mt-3 col-12">
									<!-- Other passenger details form -->
									{% include 'components/other_passenger_form.html' %}
								</div>
								{% endif %}

							</div>
						</div>

					</div>
				</div>
				{% endfor %}

			</div>
			{% endfor %}

		</div>
	</div>
</section>

{% endblock %}

{% block script %}

<script type="text/javascript">

    // CSRF token
    const csrfToken = '{{ csrf_token }}';
    
	/*
        Hide and show collapsable content for passenger form
    */
    $(".header").click(function () {

        $header = $(this);
        $content = $header.next();

        // Display content element for passenger form
        $content.slideToggle(500, function () {
            return $content.is(":visible");
        });

    });

    /*
        Display passenger form according to user selection
    */
    $(".other-passenger-form").hide();
    $(".passenger-traveling-select").change(function(){
        if( $(this).val() == "1" ) {
            $(this).parent("div").siblings(".user-passenger-form").show();
            $(this).parent("div").siblings(".other-passenger-form").hide();
        } else {
            $(this).parent("div").siblings(".user-passenger-form").hide();
            $(this).parent("div").siblings(".other-passenger-form").show();
        }
    });

    /*
        Submit passenger form without reloading the page
    */
    $(".checkmark").hide();
    $(".passenger-form").submit(function(e){
        e.preventDefault();

        var form = $(this).serialize();
        var tripId = $(this).attr("tripid").split("trip_")[1];
        console.log(tripId);

        var url = `/save-passenger/${tripId}/`;
        var data = { 'csrfmiddlewaretoken': csrfToken, 'form': form };
        
        $.post(url, data);

        // collapse card-body

        // Add class that displays a div that says passenger registered
        $(this).parents(".card-body").siblings(".card-header").children(".checkmark").show();
    });
    
</script>

{% endblock %}